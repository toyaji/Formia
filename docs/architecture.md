# Architecture Design: Formia

## 1. í•µì‹¬ ë ˆì´ì–´ ë¶„ë¦¬ ì›ì¹™

Formiaì˜ ì•„í‚¤í…ì²˜ëŠ” **ë‘ ê°œì˜ ë…ë¦½ì ì¸ ë ˆì´ì–´**ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Formia Architecture Layers                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚           ğŸ¨ Editor Layer (ì½”ì–´ëŠ” ì˜¤í”„ë¼ì¸ ë…ë¦½)               â”‚     â”‚
â”‚   â”‚                                                               â”‚     â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚     â”‚
â”‚   â”‚   â”‚ Canvas   â”‚   â”‚ AI Agent â”‚   â”‚ Block    â”‚                â”‚     â”‚
â”‚   â”‚   â”‚ Editor   â”‚   â”‚ Panel    â”‚   â”‚ Renderer â”‚                â”‚     â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚     â”‚
â”‚   â”‚        â”‚              â”‚              â”‚                       â”‚     â”‚
â”‚   â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚     â”‚
â”‚   â”‚               â”‚                                               â”‚     â”‚
â”‚   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚     â”‚
â”‚   â”‚      â”‚  Form Factor    â”‚  â† JSON (ë©”ëª¨ë¦¬ ë‚´ ìƒíƒœ)             â”‚     â”‚
â”‚   â”‚      â”‚  Store (Zustand)â”‚  â† ì˜¤í”„ë¼ì¸ì—ì„œë„ ë™ì‘               â”‚     â”‚
â”‚   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚     â”‚
â”‚   â”‚               â”‚                                               â”‚     â”‚
â”‚   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚     â”‚
â”‚   â”‚      â”‚  History/Undo   â”‚  â† Command Pattern                  â”‚     â”‚
â”‚   â”‚      â”‚  (In-Memory)    â”‚  â† DB ë¶ˆí•„ìš”                       â”‚     â”‚
â”‚   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚     â”‚
â”‚   â”‚                                                               â”‚     â”‚
â”‚   â”‚   âš¡ ì½”ì–´ í¸ì§‘ (ìº”ë²„ìŠ¤, ë¸”ë¡, Undo/Redo)ì€ ì˜¤í”„ë¼ì¸ ë…ë¦½      â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                   â”‚                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â”‚ File I/O Port  â”‚  â”‚   AI Port       â”‚                â”‚
â”‚              â”‚ save() / load()â”‚  â”‚ generatePatch() â”‚                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                       â”‚                   â”‚                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚           â”‚              â”‚  â”‚                                 â”‚     â”‚
â”‚  â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Local FSâ”‚ â”‚Cloud   â”‚ â”‚Hybridâ”‚ â”‚Tauri / Web | Unified Proxy      â”‚     â”‚
â”‚  â”‚.formia â”‚ â”‚API     â”‚ â”‚Sync  â”‚ â”‚/api/ai/generate (ì„œë²„ê°€ DBì—ì„œ í‚¤ë¥¼ êº¼ë‚´ ëŒ€ì‹  í˜¸ì¶œ) |
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚           â˜ï¸ Service Layer (ì˜¨ë¼ì¸ ì „ìš©)                   â”‚     â”‚
â”‚   â”‚                                                           â”‚     â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚
â”‚   â”‚   â”‚   Auth   â”‚ â”‚  Forms   â”‚ â”‚ Response â”‚ â”‚ AI Proxy â”‚  â”‚     â”‚
â”‚   â”‚   â”‚  OAuth   â”‚ â”‚  CRUD    â”‚ â”‚ Storage  â”‚ â”‚ Endpoint â”‚  â”‚     â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚
â”‚   â”‚                       â”‚                                   â”‚     â”‚
â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚     â”‚
â”‚   â”‚              â”‚    Database     â”‚                          â”‚     â”‚
â”‚   â”‚              â”‚  SQLite / PG    â”‚                          â”‚     â”‚
â”‚   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚     â”‚
â”‚   â”‚                                                           â”‚     â”‚
â”‚   â”‚   Form FactorëŠ” DBì— ë¶ˆíˆ¬ëª… JSON blobìœ¼ë¡œë§Œ ì €ì¥          â”‚     â”‚
â”‚   â”‚   AI ProxyëŠ” ì‚¬ìš©ì í‚¤ë¥¼ DBì—ì„œ êº¼ë‚´ Geminiì— ì „ë‹¬       â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.1 ë ˆì´ì–´ ë¶„ë¦¬ ê·œì¹™

| ê·œì¹™                 |                              Editor Layer                              |                     Service Layer                     |
| -------------------- | :--------------------------------------------------------------------: | :---------------------------------------------------: |
| **ì˜¤í”„ë¼ì¸ ë™ì‘**    |             âœ… ì½”ì–´ í¸ì§‘ì€ ë°˜ë“œì‹œ ê°€ëŠ¥. AIëŠ” ì˜¨ë¼ì¸ ì „ìš©.              |                    âŒ ì˜¨ë¼ì¸ í•„ìš”                     |
| **DB ì˜ì¡´**          |                              âŒ ì ˆëŒ€ ì—†ìŒ                              |                     âœ… Prisma/DB                      |
| **ì¸ì¦ ì˜ì¡´**        |                               âŒ ë¶ˆí•„ìš”                                |                     âœ… OAuth í•„ìˆ˜                     |
| **Form Factor ì¡°ì‘** |                              âœ… ì§ì ‘ ìˆ˜ì •                              |               âŒ ë¶ˆíˆ¬ëª… JSONìœ¼ë¡œë§Œ ì €ì¥               |
| **ìƒíƒœ ê´€ë¦¬**        |                            Zustand (ë©”ëª¨ë¦¬)                            |                       DB + API                        |
| **í•µì‹¬ ê´€ì‹¬ì‚¬**      | í¼ í¸ì§‘, ë¸”ë¡ ë Œë”ë§, Undo/Redo (ì½”ì–´)<br>AI ì—ì´ì „íŠ¸ (ì„ íƒì , ì˜¨ë¼ì¸) | ì‚¬ìš©ì ê´€ë¦¬, í¼ íŒŒì¼ ê´€ë¦¬, ë°°í¬, ì‘ë‹µ ìˆ˜ì§‘, AI í”„ë¡ì‹œ |

### 1.2 ë ˆì´ì–´ ê°„ í†µì‹ : ë‘ ê°œì˜ Port

ì—ë””í„°ì™€ ì™¸ë¶€ ì„¸ê³„ ì‚¬ì´ì—ëŠ” ì •í™•íˆ **ë‘ ê°œì˜ Port**ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤:

```
Editor Layer                                   Service Layer / ì™¸ë¶€
     â”‚                                              â”‚
     â”‚ â‘  File I/O Port                              â”‚
     â”‚   save(formFactor: JSON)                      â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  ì €ì¥ì†Œ (ë¡œì»¬ íŒŒì¼ or í´ë¼ìš°ë“œ DB)
     â”‚   load(): JSON                                â”‚
     â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                              â”‚
     â”‚ â‘¡ AI Port                                     â”‚
     â”‚   generatePatch(prompt, schema): Patch[]      â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  AI ì„œë¹„ìŠ¤ (Gemini, OpenAI ë“±)
     â”‚   patches + summary                           â”‚
     â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
     â”‚                                              â”‚
```

**ì—ë””í„°ëŠ” ë‘ ì¸í„°í˜ì´ìŠ¤(`FormRepository`, `AIPort`)ë§Œ ì•Œ ë¿, êµ¬í˜„ì²´ê°€ ë¡œì»¬/ë„¤íŠ¸ì›Œí¬/í”„ë¡ì‹œì¸ì§€ ì „í˜€ ëª¨ë¦…ë‹ˆë‹¤.**

> âš¡ í•µì‹¬: File I/O PortëŠ” ì—ë””í„°ì˜ **í•„ìˆ˜** ì˜ì¡´ì„±ì´ì§€ë§Œ, AI PortëŠ” **ì„ íƒì ** ì˜ì¡´ì„±ì…ë‹ˆë‹¤.
> AIê°€ ì—†ì–´ë„ ìˆ˜ë™ í¸ì§‘(ë¸”ë¡ ì¶”ê°€/ì‚­ì œ, ì¸ë¼ì¸ í¸ì§‘, ë“œë˜ê·¸ ë“±)ì€ ì™„ì „íˆ ë™ì‘í•©ë‹ˆë‹¤.

---

## 2. Editor Layer ìƒì„¸

### 2.1 AI Port â€” ì„ íƒì  ë¶€ê°€ ê¸°ëŠ¥

> âš ï¸ **AIëŠ” ì—ë””í„°ì˜ ì½”ì–´ê°€ ì•„ë‹ˆë¼ ì„ íƒì  í”ŒëŸ¬ê·¸ì¸ì…ë‹ˆë‹¤.**
>
> ì—ë””í„°ì˜ ì½”ì–´ ê¸°ëŠ¥(ìº”ë²„ìŠ¤ í¸ì§‘, ë¸”ë¡ ì¡°ì‘, Undo/Redo)ì€ AI ì—†ì´ ì™„ì „íˆ ë™ì‘í•©ë‹ˆë‹¤.
> AIëŠ” ì‚¬ìš©ì í¸ì˜ë¥¼ ìœ„í•œ ë¶€ê°€ ê¸°ëŠ¥ì´ë©°, ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.

#### AI Port ì¸í„°í˜ì´ìŠ¤

```typescript
// Editorê°€ ì•„ëŠ” ìœ ì¼í•œ AI ì¸í„°í˜ì´ìŠ¤
interface AIPort {
  generatePatch(prompt: string, schema: FormFactor): Promise<Operation[]>;
  isAvailable(): boolean; // í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆê³  ì—°ê²° ê°€ëŠ¥í•œì§€
}
```

#### í™˜ê²½ë³„ AI Adapter

| Adapter        | í™˜ê²½             | AI API í˜¸ì¶œ ë°©ì‹                          | í‚¤ ìœ„ì¹˜          |
| -------------- | ---------------- | ----------------------------------------- | ---------------- |
| `WebAIAdapter` | Tauri / Web ê³µí†µ | `/api/ai/generate` â†’ ì„œë²„ **í”„ë¡ì‹œ** ê²½ìœ  | ì„œë²„ DB (ì•”í˜¸í™”) |

```
Tauri (Desktop) / Web (Browser) ê³µí†µ:

Editor â†’ AIPort
           â”‚
     WebAIAdapter
           â”‚
   /api/ai/generate
  (ì„œë²„ê°€ DBì—ì„œ í‚¤ë¥¼
   êº¼ë‚´ì„œ ëŒ€ì‹  í˜¸ì¶œ)
           â”‚
           â–¼
     Gemini API
```

#### ì™œ File I/O Portì™€ ë¶„ë¦¬í•˜ëŠ”ê°€?

|                   |           File I/O Port           |           AI Port            |
| ----------------- | :-------------------------------: | :--------------------------: |
| **í•„ìˆ˜ ì—¬ë¶€**     | âœ… í•„ìˆ˜ (ì €ì¥ ì—†ì´ ì—ë””í„° ë¬´ì˜ë¯¸) |  âŒ ì„ íƒì  (ìˆ˜ë™ í¸ì§‘ ê°€ëŠ¥)  |
| **ì˜¤í”„ë¼ì¸ ë™ì‘** |        âœ… ê°€ëŠ¥ (ë¡œì»¬ íŒŒì¼)        | âŒ ë¶ˆê°€ëŠ¥ (AIê°€ ì™¸ë¶€ ì„œë¹„ìŠ¤) |
| **ì„±ê²©**          |      ì—ë””í„°ì˜ **ì¡´ì¬ ì´ìœ **       |    ì—ë””í„°ì˜ **í¸ì˜ ê¸°ëŠ¥**    |

> AIëŠ” ì™¸ë¶€ ì„œë¹„ìŠ¤(Google, OpenAI)ë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ **ì–´ì°¨í”¼ ë„¤íŠ¸ì›Œí¬ ì—†ì´ ë™ì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**.
> ì´ê²ƒì€ ë ˆì´ì–´ ë¶„ë¦¬ ì›ì¹™ì˜ ìœ„ë°˜ì´ ì•„ë‹ˆë¼, AIì˜ ë³¸ì§ˆì  íŠ¹ì„±ì…ë‹ˆë‹¤.

> ìƒì„¸ ë³´ì•ˆ: [Security Architecture](./security.md) â€” BYOK í‚¤ ê´€ë¦¬, í”„ë¡ì‹œ ì„¤ê³„
> ìƒì„¸ í”„ë¡œí† ì½œ: [AI Interaction Protocol](./ai_interaction_protocol.md)

#### The Agent-State Protocol

The AI agent doesn't just "talk"; it produces structured updates (JSON patches) to the form state.

- **Input**: User prompt + current Form Factor (JSON).
- **Output**: Proposed JSON patches + explanatory natural language.

### 2.2 Form Factor (ì—ë””í„°ì˜ ë°ì´í„° ëª¨ë¸)

Form FactorëŠ” `.formia` íŒŒì¼ì˜ JSON êµ¬ì¡°ì´ë©°, ì—ë””í„°ê°€ ë‹¤ë£¨ëŠ” **ìœ ì¼í•œ ë°ì´í„° ëª¨ë¸**ì…ë‹ˆë‹¤. DB ìŠ¤í‚¤ë§ˆë‚˜ API ì‘ë‹µ êµ¬ì¡°ì™€ëŠ” ë¬´ê´€í•©ë‹ˆë‹¤.

- **Declarative**: í¼ì´ _ë¬´ì—‡ì¸ì§€_ ê¸°ìˆ í•˜ë©°, _ì–´ë–»ê²Œ_ ì €ì¥í•˜ëŠ”ì§€ëŠ” ëª¨ë¦„.
- **Bi-directional Sync**:
  - **Agent â†’ Factor**: AIê°€ ìì—°ì–´ë¥¼ í•´ì„í•˜ì—¬ JSON Patch ìƒì„±.
  - **UI â†’ Factor**: ì‚¬ìš©ìì˜ ì§ì ‘ ì¡°ì‘ (ë“œë˜ê·¸, ì¸ë¼ì¸ í¸ì§‘)ì´ Factor ì—…ë°ì´íŠ¸.
- **Atomic Updates**: ë³€ê²½ì€ ì„¸ë¶„í™” (í•˜ë‚˜ì˜ í•„ë“œ ì¶”ê°€, í•˜ë‚˜ì˜ ìƒ‰ìƒ ë³€ê²½).
- **Self-contained**: Form Factor JSONë§Œ ìˆìœ¼ë©´ í¼ì„ ì™„ì „íˆ ë Œë”ë§ ê°€ëŠ¥. ì™¸ë¶€ ì˜ì¡´ ì—†ìŒ.

> ìƒì„¸ ìŠ¤í‚¤ë§ˆ: [Form Factor Schema](./form_factor_schema.md)

### 2.3 Frontend Architecture

- **State Management**: Zustand â€” Form Factorë¥¼ ë©”ëª¨ë¦¬ì— ë³´ê´€í•˜ëŠ” Single Source of Truth.
- **Rendering Engine**: JSON ìŠ¤í‚¤ë§ˆë¥¼ íŒŒì‹±í•˜ì—¬ ì»´í¬ë„ŒíŠ¸ë¥¼ ë™ì ìœ¼ë¡œ ë Œë”ë§.
- **Canvas Interaction**: ë“œë˜ê·¸ ì•¤ ë“œë¡­, ì¸ë¼ì¸ í¸ì§‘ â†’ ëª¨ë‘ Zustand Storeì— ë°˜ì˜.

### 2.4 History & Version Control (ì—ë””í„° ë‚´ë¶€)

Undo/Redoì™€ ë³€ê²½ ì´ë ¥ì€ **ì—ë””í„° ë‚´ë¶€ì—ì„œ ë©”ëª¨ë¦¬ë¡œ ê´€ë¦¬**ë©ë‹ˆë‹¤. DBì™€ ë¬´ê´€í•©ë‹ˆë‹¤.

#### Command Pattern (In-Memory)

- ëª¨ë“  Form Factor ìˆ˜ì •ì€ **Command** ê°ì²´ë¡œ ìº¡ìŠí™”.
- **Undo Stack**: ì ìš©ëœ ì»¤ë§¨ë“œì˜ ì—­ì—°ì‚° ì €ì¥.
- **Redo Stack**: Undoëœ ì»¤ë§¨ë“œ ì €ì¥.
- ì„¸ë°€í•œ ì¦‰ê°ì  Undo/Redo ì§€ì›.

#### Change Tracking

- **Snapshotting**: ì£¼ìš” ë³€ê²½ (AI ìƒí˜¸ì‘ìš© ì»¤ë°‹) ì‹œ Form Factor ì „ì²´ ìŠ¤ëƒ…ìƒ· ìƒì„±.
- **JSON Diffs (RFC 6902)**: ê° ë‹¨ê³„ì—ì„œ ì ìš©ëœ íŒ¨ì¹˜ë¥¼ ì €ì¥. ì €ì¥ íš¨ìœ¨ì ì´ê³  ë³€ê²½ ë‚´ì—­ì„ ì‹œê°í™” ê°€ëŠ¥.

#### Versioning

- **Checkpoints**: ì‚¬ìš©ìê°€ "Checkpoints" (ë²„ì „)ì„ ìˆ˜ë™ ì €ì¥ ê°€ëŠ¥.
- **History Metadata**: ê° ë³€ê²½ì— í¬í•¨ë˜ëŠ” ì •ë³´:
  - `author`: "human" ë˜ëŠ” "ai"
  - `timestamp`: ë³€ê²½ ì‹œì 
  - `description`: "ì´ë©”ì¼ í•„ë“œ ì¶”ê°€" (AI ìƒì„± ìš”ì•½)
- **`.formia` íŒŒì¼ ë‚´ ì €ì¥**: `_history` í•„ë“œì— ì²´í¬í¬ì¸íŠ¸ ê¸°ë¡ (ì—ë””í„° ìì²´ ê´€ë¦¬).

---

## 3. Service Layer ê°œìš”

Service LayerëŠ” **ì˜¨ë¼ì¸ ì„œë¹„ìŠ¤ ê¸°ëŠ¥**ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. ì—ë””í„°ì™€ ì§ì ‘ í†µì‹ í•˜ì§€ ì•Šê³ , File I/O Port (Repository ì–´ëŒ‘í„°)ë¥¼ í†µí•´ì„œë§Œ Form Factorë¥¼ ì£¼ê³ ë°›ìŠµë‹ˆë‹¤.

### 3.1 Service Layer ë‹´ë‹¹ ì˜ì—­

| ì˜ì—­             | ì„¤ëª…                                     |
| ---------------- | ---------------------------------------- |
| **ì‚¬ìš©ì ì¸ì¦**  | OAuth (Google, GitHub), JWT ì„¸ì…˜ ê´€ë¦¬    |
| **í¼ íŒŒì¼ ê´€ë¦¬** | ì‚¬ìš©ìë³„ í¼ ëª©ë¡, CRUD, í´ë¼ìš°ë“œ ì €ì¥    |
| **í¼ ë°°í¬**      | ê³µê°œ URL ìƒì„±, ì •ì  HTML/CDN ë°°í¬        |
| **ì‘ë‹µ ìˆ˜ì§‘**    | ë°°í¬ëœ í¼ì—ì„œì˜ ì‘ë‹µ ì €ì¥/ì¡°íšŒ           |
| **ë™ê¸°í™”**       | Desktop ì•±ì˜ ë¡œì»¬ íŒŒì¼ â†” í´ë¼ìš°ë“œ ë™ê¸°í™” |

### 3.2 Service Layerì˜ Form Factor ì·¨ê¸‰

**Service LayerëŠ” Form Factorì˜ ë‚´ë¶€ êµ¬ì¡°ë¥¼ í•´ì„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**

```
ì—ë””í„° â†’ save({ pages: [...], theme: {...}, ... })
                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Service Layer     â”‚
          â”‚                    â”‚
          â”‚  Form í…Œì´ë¸”ì—     â”‚
          â”‚  factor: Json ìœ¼ë¡œ â”‚  â† ë¶ˆíˆ¬ëª… blob. ë‚´ë¶€ë¥¼ ì—´ì–´ë³´ì§€ ì•ŠìŒ.
          â”‚  ê·¸ëŒ€ë¡œ ì €ì¥        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ìƒì„¸: [Cloud Architecture](./cloud_architecture.md), [Infrastructure](./infrastructure.md)

---

## 4. Deployment Strategy: Figma-like Hybrid Model

FormiaëŠ” **Web ìš°ì„  + Desktop ë³´ì¡°** í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸ì„ ì±„íƒí•©ë‹ˆë‹¤.

### 4.1 Two Client Modes

| ëª¨ë“œ                      | í”Œë«í¼  |     ì¸ì¦     |     Editor Layer     |     Service Layer     |
| ------------------------- | ------- | :----------: | :------------------: | :-------------------: |
| **Web Client (ì£¼ë ¥)**     | Next.js | í•„ìˆ˜ (OAuth) | âœ… ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘ | âœ… í´ë¼ìš°ë“œ ì €ì¥/ë°°í¬ |
| **Desktop Client (ë³´ì¡°)** | Tauri   |    ì„ íƒì     |   âœ… ì˜¤í”„ë¼ì¸ ë™ì‘   |   ë¡œê·¸ì¸ ì‹œ ë™ê¸°í™”    |

### 4.2 í•µì‹¬: ì—ë””í„°ëŠ” ì–‘ìª½ ëª¨ë‘ì—ì„œ ë™ì¼í•˜ê²Œ ë™ì‘

- **Web**: ì—ë””í„°ê°€ ë¸Œë¼ìš°ì €ì—ì„œ êµ¬ë™. File I/OëŠ” Cloud API Adapterë¥¼ ì‚¬ìš©.
- **Desktop**: ì—ë””í„°ê°€ Tauriì—ì„œ êµ¬ë™. File I/OëŠ” Local FS Adapterë¥¼ ì‚¬ìš©.
- **Desktop + ë¡œê·¸ì¸**: Hybrid Adapterê°€ ë¡œì»¬ ì €ì¥ + ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”.
- ì–´ë–¤ í™˜ê²½ì—ì„œë“  **ì—ë””í„° ì½”ë“œëŠ” ë™ì¼**. Adapterë§Œ êµì²´.

### 4.3 Technical Stack

- **Web Frontend**: Next.js 14+ (App Router)
- **Desktop**: Tauri 2.0 (Rust backend)
- **Backend**: Next.js API Routes (Phase 1-2) â†’ NestJS (Phase 3+)
- **ORM**: Prisma
- **Database**: SQLite (ê°œë°œ) â†’ PostgreSQL (í”„ë¡œë•ì…˜)
- **Auth**: NextAuth.js (OAuth 2.0)
- **Editor State**: Zustand (Form Factor â€” ë©”ëª¨ë¦¬ ë‚´)
- **AI Integration**: Multi-provider SDKs (Gemini, OpenAI, Anthropic) â€” BYOK ëª¨ë¸
- **Data Format**: `.formia` (JSON)

> ìƒì„¸: [Infrastructure](./infrastructure.md), [Cloud Architecture](./cloud_architecture.md)

## 5. Testing & Quality Assurance

For a detailed breakdown, see [Testing Strategy](./testing_strategy.md).

---

## ê´€ë ¨ ë¬¸ì„œ

- [Security Architecture](./security.md) - BYOK API í‚¤ ë³´ì•ˆ, ì•”í˜¸í™”, ìœ„í˜‘ ëª¨ë¸
- [Cloud Architecture](./cloud_architecture.md) - í´ë¼ìš°ë“œ/ì¸ì¦/ë°°í¬ ì„¤ê³„ (Service Layer ìƒì„¸)
- [Infrastructure](./infrastructure.md) - ì¸í”„ë¼/DB/ì„œë²„ ë°°í¬ ì „ëµ (Service Layer ì¸í”„ë¼)
- [Form Factor Schema](./form_factor_schema.md) - Form Factor JSON ìŠ¤í‚¤ë§ˆ (Editor Layer ë°ì´í„° ëª¨ë¸)
- [Code Design Patterns](./code_design_patterns.md) - ì½”ë“œ íŒ¨í„´ ë° ì•„í‚¤í…ì²˜ ë ˆì´ì–´
- [AI Interaction Protocol](./ai_interaction_protocol.md) - AI Agent í†µì‹  ë° BYOK í‚¤ ê´€ë¦¬
